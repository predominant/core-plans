# Configuration file generated by Habitat
# Reference: https://prometheus.io/docs/prometheus/latest/configuration/configuration/
global:
  scrape_interval: {{cfg.scrape_interval}}
  evaluation_interval: {{cfg.evaluation_interval}}
  external_labels:
    monitor: 'codelab-monitor'

rule_files:
scrape_configs:
  - job_name: 'prometheus'
    static_configs:
      - targets: ['localhost:{{cfg.listening_port}}']
{{#if bind.targets}}
  - job_name:  'from_hab_ring'
    static_configs:
{{#each bind.targets.members as |target|}}
      - targets: ['{{target.sys.ip}}:{{target.cfg.metric-http-port}}']
{{/each ~}}
{{/if ~}}

{{#if svc.me.follower}}
# example from https://prometheus.io/docs/operating/federation/
  - job_name: 'federate'
    scrape_interval: 15s

    honor_labels: true
    metrics_path: '/federate'

    params:
      'match[]':
        - '{job="prometheus"}'
        - '{__name__=~"job:.*"}'

    static_configs:
      - targets:
        - '{{svc.leader.sys.ip}}:{{svc.leader.cfg.prom_ds_http}}'
{{/if ~}}
